{{- if .Values.api.enabled -}}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "torale.fullname" . }}-migrations
  labels:
    {{- include "torale.labels" . | nindent 4 }}
    app.kubernetes.io/component: migrations
  annotations:
    # Run before deployment (pre-install, pre-upgrade)
    "helm.sh/hook": pre-install,pre-upgrade
    # Run migrations before other resources
    "helm.sh/hook-weight": "-5"
    # Delete old job before creating new one
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  # Don't keep successful jobs around
  ttlSecondsAfterFinished: 60
  # Kill job after 5 minutes (migrations should complete in ~10 seconds)
  activeDeadlineSeconds: 300
  # Don't retry on failure - migrations are idempotent
  backoffLimit: 0
  template:
    metadata:
      labels:
        {{- include "torale.labels" . | nindent 8 }}
        app.kubernetes.io/component: migrations
    spec:
      # Don't restart on failure
      restartPolicy: Never
      serviceAccountName: {{ include "torale.serviceAccountName" . }}
      {{- with .Values.api.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.api.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}

      containers:
      # Migration container
      - name: migrations
        image: {{ include "torale.api.image" . }}
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        command:
        - /bin/bash
        - -c
        - |
          set -e
          echo "Waiting for Cloud SQL proxy..."
          until pg_isready -h localhost -p {{ .Values.database.port }} 2>/dev/null; do
            echo "Cloud SQL proxy not ready yet..."
            sleep 2
          done
          echo "Cloud SQL proxy is ready!"
          sleep 2
          echo "Running database migrations..."
          alembic upgrade head
          echo "Migrations completed successfully!"
          echo "Job will be terminated by activeDeadlineSeconds after success"

          # Sleep to keep container alive until activeDeadlineSeconds kills the job
          # This allows checking logs before cleanup
          sleep infinity
        env:
        - name: DATABASE_URL
          value: {{ include "torale.databaseUrl" . | quote }}
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ .Values.secrets.name }}
              key: DB_PASSWORD
        envFrom:
        - configMapRef:
            name: {{ include "torale.fullname" . }}-config
        - secretRef:
            name: {{ .Values.secrets.name }}
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "500m"

      {{- if .Values.cloudsql.enabled }}
      # Cloud SQL Proxy sidecar (same as API deployment)
      - name: cloud-sql-proxy
        image: {{ .Values.cloudsql.image }}
        args:
        - "--structured-logs"
        - "--port={{ .Values.database.port }}"
        - "{{ .Values.database.connectionName }}"
        securityContext:
          runAsNonRoot: true
        resources:
          {{- toYaml .Values.cloudsql.resources | nindent 10 }}
      {{- end }}
{{- end }}
