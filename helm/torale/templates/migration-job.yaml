{{- if .Values.api.enabled -}}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "torale.fullname" . }}-migrations
  labels:
    {{- include "torale.labels" . | nindent 4 }}
    app.kubernetes.io/component: migrations
  annotations:
    # Run before deployment (pre-install, pre-upgrade)
    "helm.sh/hook": pre-install,pre-upgrade
    # Run migrations before other resources
    "helm.sh/hook-weight": "-5"
    # Delete old job before creating new one
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  # Don't keep successful jobs around
  ttlSecondsAfterFinished: 60
  template:
    metadata:
      labels:
        {{- include "torale.labels" . | nindent 8 }}
        app.kubernetes.io/component: migrations
    spec:
      # Don't restart on failure
      restartPolicy: Never
      # Share process namespace so migration container can signal proxy
      shareProcessNamespace: true
      # Give proxy time to shutdown gracefully on SIGTERM
      terminationGracePeriodSeconds: 20
      serviceAccountName: {{ include "torale.serviceAccountName" . }}
      {{- with .Values.api.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.api.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}

      containers:
      # Migration container
      - name: migrations
        image: {{ include "torale.api.image" . }}
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        command:
        - /bin/bash
        - -c
        - |
          set -e
          echo "Waiting for Cloud SQL proxy..."
          # Wait for proxy to be ready (retry for 30 seconds)
          for i in $(seq 1 30); do
            (</dev/tcp/127.0.0.1/{{ .Values.database.port }}) 2>/dev/null && break || sleep 1
          done
          echo "Cloud SQL proxy is ready!"

          echo "Running database migrations..."
          alembic upgrade head
          echo "Migrations completed successfully!"

          # Signal Cloud SQL Proxy to shutdown gracefully (SIGTERM â†’ exit 0)
          echo "Signaling Cloud SQL Proxy to terminate..."
          pkill -TERM cloud-sql-proxy || true

          # Wait for proxy process to actually exit (not just start shutting down)
          echo "Waiting for proxy to exit..."
          while pgrep -f cloud-sql-proxy > /dev/null 2>&1; do
            sleep 1
          done
          echo "Proxy has exited"

          # Ensure main container exits with code 0
          exit 0
        env:
        - name: DATABASE_URL
          value: {{ include "torale.databaseUrl" . | quote }}
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ .Values.secrets.name }}
              key: DB_PASSWORD
        envFrom:
        - configMapRef:
            name: {{ include "torale.fullname" . }}-config
        - secretRef:
            name: {{ .Values.secrets.name }}
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "500m"

      {{- if .Values.cloudsql.enabled }}
      # Cloud SQL Proxy sidecar (same as API deployment)
      - name: cloud-sql-proxy
        image: {{ .Values.cloudsql.image }}
        args:
        - "--structured-logs"
        - "--port={{ .Values.database.port }}"
        - "--max-sigterm-delay=10s"
        - "{{ .Values.database.connectionName }}"
        securityContext:
          runAsNonRoot: true
        resources:
          {{- toYaml .Values.cloudsql.resources | nindent 10 }}
      {{- end }}
{{- end }}
