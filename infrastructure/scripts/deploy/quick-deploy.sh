#!/bin/bash

# Quick deployment script for fast iteration using modular infrastructure
# This deploys services using the new module structure

set -e

echo "üöÄ Quick Deploy - Fast iteration mode (Modular Infrastructure)..."

# Navigate to the dev environment directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DEV_DIR="$SCRIPT_DIR/../../terraform/environments/dev"
PROJECT_ROOT="$SCRIPT_DIR/../../../"

cd "$DEV_DIR"

# Check if terraform.tfvars exists
if [ ! -f "terraform.tfvars" ]; then
    echo "‚ùå Error: terraform.tfvars file not found in $DEV_DIR"
    echo "üí° Create it by copying from shared/terraform.tfvars.example and filling in your values"
    exit 1
fi

# Extract project info
PROJECT_ID=$(grep '^project_id' terraform.tfvars | cut -d'"' -f2)
if [ -z "$PROJECT_ID" ]; then
    echo "‚ùå Error: project_id not found in terraform.tfvars"
    exit 1
fi

echo "üìã Project ID: $PROJECT_ID"

# Check if basic infrastructure exists
echo "üîç Checking if basic infrastructure exists..."
terraform init > /dev/null

if ! terraform show | grep -q "module.artifact_registry"; then
    echo "‚ùå Error: Artifact Registry module not found. Run terraform apply first to create basic infrastructure."
    exit 1
fi

# Get the artifact registry URL
REGISTRY_URL=$(terraform output -raw artifact_registry_url)
echo "üì¶ Registry URL: $REGISTRY_URL"

# Configure Docker authentication
echo "üîê Configuring Docker authentication..."
gcloud auth configure-docker us-central1-docker.pkg.dev --quiet

# Extract Supabase variables for frontend build
SUPABASE_URL=$(grep '^supabase_url' terraform.tfvars | cut -d'"' -f2)
SUPABASE_ANON_KEY=$(grep '^supabase_anon_key' terraform.tfvars | cut -d'"' -f2)

if [ -z "$SUPABASE_URL" ] || [ -z "$SUPABASE_ANON_KEY" ]; then
    echo "‚ùå Error: Supabase URL or anon key not found in terraform.tfvars"
    exit 1
fi

# Navigate to project root
cd "$PROJECT_ROOT"

echo "üê≥ Building and pushing Docker images..."

# Build and push frontend
echo "üåê Building frontend..."
docker build --platform=linux/amd64 -t $REGISTRY_URL/frontend:latest \
  --build-arg NEXT_PUBLIC_SUPABASE_URL="$SUPABASE_URL" \
  --build-arg NEXT_PUBLIC_SUPABASE_ANON_KEY="$SUPABASE_ANON_KEY" \
  -f frontend/Dockerfile.production ./frontend
docker push $REGISTRY_URL/frontend:latest

# Build and push backend
echo "‚öôÔ∏è  Building main backend..."
docker build --platform=linux/amd64 -t $REGISTRY_URL/backend:latest -f backend/Dockerfile ./backend
docker push $REGISTRY_URL/backend:latest

# Build and push microservices
echo "üîç Building discovery service..."
docker build --platform=linux/amd64 -t $REGISTRY_URL/discovery-service:latest -f discovery-service/Dockerfile ./discovery-service
docker push $REGISTRY_URL/discovery-service:latest

echo "üëÅÔ∏è  Building monitoring service..."
docker build --platform=linux/amd64 -t $REGISTRY_URL/content-monitoring-service:latest -f content-monitoring-service/Dockerfile ./content-monitoring-service
docker push $REGISTRY_URL/content-monitoring-service:latest

echo "üìß Building notification service..."
docker build --platform=linux/amd64 -t $REGISTRY_URL/notification-service:latest -f notification-service/Dockerfile ./notification-service
docker push $REGISTRY_URL/notification-service:latest

# Navigate back to dev environment directory
cd "$DEV_DIR"

# Deploy Cloud Run services using the modular structure
echo "‚òÅÔ∏è  Deploying Cloud Run services..."
terraform apply \
  -target=module.cloud_run \
  -auto-approve

echo "‚úÖ Quick deploy complete!"
echo ""
echo "üîó Service URLs:"
terraform output

echo ""
echo "üí° For even faster iteration:"
echo "   ./quick-deploy.sh    # Rebuild and redeploy all services"
echo "   terraform output     # View service URLs" 