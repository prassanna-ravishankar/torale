steps:
  # Build API image
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-api'
    args:
      - 'build'
      - '-t'
      - 'gcr.io/$PROJECT_ID/torale-api:$COMMIT_SHA'
      - '-t'
      - 'gcr.io/$PROJECT_ID/torale-api:latest'
      - '-f'
      - 'backend/Dockerfile'
      - 'backend'

  # Build Worker image (same dockerfile, different CMD)
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-worker'
    args:
      - 'build'
      - '-t'
      - 'gcr.io/$PROJECT_ID/torale-worker:$COMMIT_SHA'
      - '-t'
      - 'gcr.io/$PROJECT_ID/torale-worker:latest'
      - '-f'
      - 'backend/Dockerfile'
      - 'backend'

  # Build Frontend image (multi-stage: React build â†’ nginx)
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-frontend'
    args:
      - 'build'
      - '-t'
      - 'gcr.io/$PROJECT_ID/torale-frontend:$COMMIT_SHA'
      - '-t'
      - 'gcr.io/$PROJECT_ID/torale-frontend:latest'
      - '-f'
      - 'frontend/Dockerfile'
      - 'frontend'

  # Push API image
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-api-sha'
    args: ['push', 'gcr.io/$PROJECT_ID/torale-api:$COMMIT_SHA']
    waitFor: ['build-api']

  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-api-latest'
    args: ['push', 'gcr.io/$PROJECT_ID/torale-api:latest']
    waitFor: ['build-api']

  # Push Worker image
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-worker-sha'
    args: ['push', 'gcr.io/$PROJECT_ID/torale-worker:$COMMIT_SHA']
    waitFor: ['build-worker']

  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-worker-latest'
    args: ['push', 'gcr.io/$PROJECT_ID/torale-worker:latest']
    waitFor: ['build-worker']

  # Push Frontend image
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-frontend-sha'
    args: ['push', 'gcr.io/$PROJECT_ID/torale-frontend:$COMMIT_SHA']
    waitFor: ['build-frontend']

  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-frontend-latest'
    args: ['push', 'gcr.io/$PROJECT_ID/torale-frontend:latest']
    waitFor: ['build-frontend']

  # Deploy to GKE via Helmfile
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-gke'
    entrypoint: bash
    args:
      - '-c'
      - |
        # Install helm
        curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

        # Install helmfile
        wget -O /usr/local/bin/helmfile https://github.com/helmfile/helmfile/releases/download/v0.158.0/helmfile_linux_amd64
        chmod +x /usr/local/bin/helmfile

        # Install helm-diff plugin
        helm plugin install https://github.com/databus23/helm-diff || true

        # Get GKE credentials
        gcloud container clusters get-credentials clusterkit \
          --region us-central1 \
          --project $PROJECT_ID

        # Deploy via Helmfile (app tier only, Temporal should already be deployed)
        helmfile sync --selector tier=app --set image.tag=$COMMIT_SHA
    waitFor:
      - 'push-api-latest'
      - 'push-worker-latest'
      - 'push-frontend-latest'

substitutions:
  _REGION: us-central1

options:
  logging: CLOUD_LOGGING_ONLY
  machineType: 'E2_HIGHCPU_8'

timeout: 1200s
