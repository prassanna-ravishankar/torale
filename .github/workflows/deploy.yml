# GitHub Actions Workflow for Torale
# Alternative to Cloud Build triggers
#
# This workflow provides the same functionality as cloudbuild.yaml but runs on GitHub Actions.
# Use this if you prefer GitHub Actions over Cloud Build.
#
# Setup:
# 1. Create GCP service account with GKE/GCR permissions
# 2. Create service account key JSON
# 3. Add as GitHub secret: GCP_SA_KEY
# 4. Add GitHub secrets: GCP_PROJECT_ID, GKE_CLUSTER, GKE_ZONE

name: Deploy to GKE

on:
  push:
    branches:
      - main
      - 'feat/**'
      - 'fix/**'
  pull_request:
    branches:
      - main

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GKE_CLUSTER: clusterkit
  GKE_ZONE: us-central1
  IMAGE_TAG: ${{ github.sha }}

jobs:
  # ============================================================================
  # Validate and Setup
  # ============================================================================
  validate:
    name: Validate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check required files
        run: |
          echo "üîç Validating project structure..."
          test -f backend/Dockerfile || (echo "‚ùå backend/Dockerfile not found" && exit 1)
          test -f frontend/Dockerfile || (echo "‚ùå frontend/Dockerfile not found" && exit 1)
          test -f helmfile.yaml || (echo "‚ùå helmfile.yaml not found" && exit 1)
          test -d helm/torale || (echo "‚ùå helm/torale not found" && exit 1)
          echo "‚úÖ All required files present"

  # ============================================================================
  # Build and Push Images
  # ============================================================================
  build:
    name: Build Images
    runs-on: ubuntu-latest
    needs: validate

    strategy:
      matrix:
        component: [api, worker, frontend]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          export_default_credentials: true

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker

      - name: Determine Dockerfile
        id: dockerfile
        run: |
          if [ "${{ matrix.component }}" = "frontend" ]; then
            echo "path=frontend/Dockerfile" >> $GITHUB_OUTPUT
            echo "context=frontend" >> $GITHUB_OUTPUT
          else
            echo "path=backend/Dockerfile" >> $GITHUB_OUTPUT
            echo "context=backend" >> $GITHUB_OUTPUT
          fi

      - name: Build and push ${{ matrix.component }}
        run: |
          IMAGE_NAME="gcr.io/${{ env.GCP_PROJECT_ID }}/torale-${{ matrix.component }}"

          docker build \
            -t "${IMAGE_NAME}:${{ env.IMAGE_TAG }}" \
            -t "${IMAGE_NAME}:latest" \
            -f ${{ steps.dockerfile.outputs.path }} \
            ${{ steps.dockerfile.outputs.context }}

          docker push "${IMAGE_NAME}:${{ env.IMAGE_TAG }}"
          docker push "${IMAGE_NAME}:latest"

  # ============================================================================
  # Security Scanning
  # ============================================================================
  scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build

    strategy:
      matrix:
        component: [api, worker, frontend]

    steps:
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker

      - name: Pull image
        run: docker pull gcr.io/${{ env.GCP_PROJECT_ID }}/torale-${{ matrix.component }}:${{ env.IMAGE_TAG }}

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: gcr.io/${{ env.GCP_PROJECT_ID }}/torale-${{ matrix.component }}:${{ env.IMAGE_TAG }}
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'  # Don't fail on vulnerabilities

  # ============================================================================
  # Deploy to Production
  # ============================================================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build, scan]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
            --region ${{ env.GKE_ZONE }} \
            --project ${{ env.GCP_PROJECT_ID }}

      - name: Install Helm
        run: |
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      - name: Install Helmfile
        run: |
          wget -O /usr/local/bin/helmfile \
            https://github.com/helmfile/helmfile/releases/download/v0.162.0/helmfile_linux_amd64
          chmod +x /usr/local/bin/helmfile
          helm plugin install https://github.com/databus23/helm-diff --version v3.9.4

      - name: Deploy via Helmfile
        run: |
          helmfile sync \
            --selector tier=app \
            --set image.tag=${{ env.IMAGE_TAG }} \
            --set global.projectId=${{ env.GCP_PROJECT_ID }}

      - name: Verify deployment
        run: |
          kubectl rollout status deployment/torale-api -n torale --timeout=5m
          kubectl rollout status deployment/torale-worker -n torale --timeout=5m
          kubectl rollout status deployment/torale-frontend -n torale --timeout=5m

      - name: Get deployment info
        run: |
          echo "üìä Deployment Summary:"
          kubectl get pods -n torale -o wide
          kubectl get ingress -n torale

  # ============================================================================
  # Deploy to Branch Environment
  # ============================================================================
  deploy-branch:
    name: Deploy to Branch
    runs-on: ubuntu-latest
    needs: [build, scan]
    if: github.ref != 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate branch metadata
        id: metadata
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          BRANCH_SLUG=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9-]/-/g' | tr '[:upper:]' '[:lower:]' | cut -c1-30)
          NAMESPACE="torale-$BRANCH_SLUG"

          echo "branch_slug=$BRANCH_SLUG" >> $GITHUB_OUTPUT
          echo "namespace=$NAMESPACE" >> $GITHUB_OUTPUT

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
            --region ${{ env.GKE_ZONE }} \
            --project ${{ env.GCP_PROJECT_ID }}

      - name: Create namespace
        run: |
          kubectl create namespace ${{ steps.metadata.outputs.namespace }} --dry-run=client -o yaml | kubectl apply -f -
          kubectl label namespace ${{ steps.metadata.outputs.namespace }} \
            type=branch-deployment \
            branch=${{ steps.metadata.outputs.branch_slug }} \
            managed-by=github-actions \
            --overwrite

      - name: Copy secrets
        run: |
          if kubectl get secret torale-secrets -n torale &>/dev/null; then
            kubectl get secret torale-secrets -n torale -o yaml | \
              sed "s/namespace: torale/namespace: ${{ steps.metadata.outputs.namespace }}/" | \
              kubectl apply -f - || echo "‚ö†Ô∏è Could not copy secrets"
          fi

      - name: Install Helm
        run: |
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      - name: Deploy to branch namespace
        run: |
          helm upgrade --install torale-${{ steps.metadata.outputs.branch_slug }} ./helm/torale \
            --namespace ${{ steps.metadata.outputs.namespace }} \
            --create-namespace \
            --set image.tag=${{ env.IMAGE_TAG }} \
            --set global.projectId=${{ env.GCP_PROJECT_ID }} \
            --set api.replicaCount=1 \
            --set api.autoscaling.enabled=false \
            --set worker.replicaCount=1 \
            --set worker.autoscaling.enabled=false \
            --set frontend.replicaCount=1 \
            --set frontend.autoscaling.enabled=false \
            --set ingress.enabled=false \
            --set certificate.enabled=false \
            --wait \
            --timeout 10m

      - name: Show deployment info
        run: |
          echo "üéâ Branch deployment completed!"
          echo "Branch: ${{ github.ref_name }}"
          echo "Namespace: ${{ steps.metadata.outputs.namespace }}"
          echo ""
          kubectl get pods,svc -n ${{ steps.metadata.outputs.namespace }}
