# Production deployment workflow
# Triggers on push to main branch
# Deploys to torale namespace
# Uses Workload Identity Federation for keyless authentication

name: Production Deployment

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual triggering

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GKE_CLUSTER: clusterkit
  GKE_REGION: us-central1
  IMAGE_TAG: ${{ github.sha }}

jobs:
  # Validate project structure
  validate:
    name: Validate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate project structure
        run: |
          echo "üîç Validating project structure..."
          test -f backend/Dockerfile || (echo "‚ùå backend/Dockerfile not found" && exit 1)
          test -f frontend/Dockerfile || (echo "‚ùå frontend/Dockerfile not found" && exit 1)
          test -f helmfile.yaml || (echo "‚ùå helmfile.yaml not found" && exit 1)
          test -d helm/torale || (echo "‚ùå helm/torale not found" && exit 1)
          echo "‚úÖ All required files present"

  # Build and scan (reusable workflow)
  build:
    name: Build & Scan
    needs: validate
    uses: ./.github/workflows/build.yml
    permissions:
      contents: read
      id-token: write  # Required for nested jobs to use OIDC
    with:
      push_latest: true
    secrets:
      GCP_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
      GCP_SERVICE_ACCOUNT: ${{ secrets.GCP_SERVICE_ACCOUNT }}
      GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}

  # Deploy to production
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build

    permissions:
      contents: read
      id-token: write  # Required for OIDC

    environment:
      name: production
      url: https://torale.ai

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
            --region ${{ env.GKE_REGION }} \
            --project ${{ env.GCP_PROJECT_ID }}

      - name: Install Helmfile
        uses: helmfile/helmfile-action@v1
        with:
          helmfile-version: v0.162.0

      - name: Deploy via Helmfile
        run: |
          echo "üöÄ Deploying to production..."
          helmfile sync \
            --selector tier=app \
            --set image.tag=${{ env.IMAGE_TAG }} \
            --set image.repository=${{ env.GCP_PROJECT_ID }} \
            --set global.projectId=${{ env.GCP_PROJECT_ID }}

      - name: Verify deployment
        run: |
          echo "‚úÖ Verifying deployment..."
          kubectl rollout status deployment/torale-api -n torale --timeout=5m
          kubectl rollout status deployment/torale-worker -n torale --timeout=5m
          kubectl rollout status deployment/torale-frontend -n torale --timeout=5m

      - name: Deployment summary
        run: |
          echo "üéâ Production deployment completed!"
          echo ""
          kubectl get pods -n torale -o wide
          echo ""
          kubectl get ingress -n torale
