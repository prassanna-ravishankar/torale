# Pull request checks
# Validates and builds on PR, but doesn't deploy
# Uses Workload Identity Federation for keyless authentication

name: PR Checks

on:
  pull_request:
    branches:
      - main

jobs:
  # Validate project structure
  validate:
    name: Validate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate project structure
        run: |
          echo "üîç Validating project structure..."
          test -f backend/Dockerfile || (echo "‚ùå backend/Dockerfile not found" && exit 1)
          test -f frontend/Dockerfile || (echo "‚ùå frontend/Dockerfile not found" && exit 1)
          test -f helmfile.yaml || (echo "‚ùå helmfile.yaml not found" && exit 1)
          test -d helm/torale || (echo "‚ùå helm/torale not found" && exit 1)
          echo "‚úÖ All required files present"

  # Build and scan (reusable workflow)
  build:
    name: Build & Scan
    needs: validate
    uses: ./.github/workflows/build.yml
    with:
      push_latest: false
    secrets:
      GCP_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
      GCP_SERVICE_ACCOUNT: ${{ secrets.GCP_SERVICE_ACCOUNT }}
      GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}

  # Summary
  summary:
    name: PR Check Summary
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Summary
        run: |
          echo "‚úÖ All checks passed!"
          echo "Images built and scanned successfully"
          echo "Ready to merge"
