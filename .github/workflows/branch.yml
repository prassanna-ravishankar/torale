# Branch deployment workflow
# Triggers on push to feature branches
# Deploys to isolated test namespace (torale-{branch-slug})
# Uses Workload Identity Federation for keyless authentication

name: Branch Deployment

on:
  push:
    branches:
      - 'feat/**'
      - 'fix/**'
      - 'refactor/**'

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GKE_CLUSTER: clusterkit
  GKE_REGION: us-central1
  IMAGE_TAG: ${{ github.sha }}

jobs:
  # Build and scan (reusable workflow)
  build:
    name: Build & Scan
    uses: ./.github/workflows/build.yml
    with:
      push_latest: false
    secrets:
      GCP_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
      GCP_SERVICE_ACCOUNT: ${{ secrets.GCP_SERVICE_ACCOUNT }}
      GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}

  # Deploy to branch namespace
  deploy:
    name: Deploy to Branch
    runs-on: ubuntu-latest
    needs: build

    permissions:
      contents: read
      id-token: write  # Required for OIDC

    environment:
      name: branch-${{ github.ref_name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate branch metadata
        id: metadata
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          BRANCH_SLUG=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9-]/-/g' | tr '[:upper:]' '[:lower:]' | cut -c1-30)
          NAMESPACE="torale-$BRANCH_SLUG"

          echo "branch_slug=$BRANCH_SLUG" >> $GITHUB_OUTPUT
          echo "namespace=$NAMESPACE" >> $GITHUB_OUTPUT

          echo "Branch: $BRANCH_NAME â†’ Namespace: $NAMESPACE"

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
            --region ${{ env.GKE_REGION }} \
            --project ${{ env.GCP_PROJECT_ID }}

      - name: Create and label namespace
        run: |
          kubectl create namespace ${{ steps.metadata.outputs.namespace }} \
            --dry-run=client -o yaml | kubectl apply -f -

          kubectl label namespace ${{ steps.metadata.outputs.namespace }} \
            type=branch-deployment \
            branch=${{ steps.metadata.outputs.branch_slug }} \
            managed-by=github-actions \
            --overwrite

      - name: Copy production secrets
        run: |
          if kubectl get secret torale-secrets -n torale &>/dev/null; then
            kubectl get secret torale-secrets -n torale -o yaml | \
              sed "s/namespace: torale/namespace: ${{ steps.metadata.outputs.namespace }}/" | \
              kubectl apply -f -
          else
            echo "âš ï¸  Production secrets not found, branch deployment may fail"
          fi

      - name: Install Helm
        run: |
          curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      - name: Deploy to branch namespace
        run: |
          echo "ğŸš€ Deploying to ${{ steps.metadata.outputs.namespace }}..."

          helm upgrade --install torale-${{ steps.metadata.outputs.branch_slug }} ./helm/torale \
            --namespace ${{ steps.metadata.outputs.namespace }} \
            --create-namespace \
            --set image.tag=${{ env.IMAGE_TAG }} \
            --set global.projectId=${{ env.GCP_PROJECT_ID }} \
            --set api.replicaCount=1 \
            --set api.autoscaling.enabled=false \
            --set worker.replicaCount=1 \
            --set worker.autoscaling.enabled=false \
            --set frontend.replicaCount=1 \
            --set frontend.autoscaling.enabled=false \
            --set ingress.enabled=false \
            --set certificate.enabled=false \
            --wait \
            --timeout 10m

      - name: Deployment summary
        run: |
          echo "ğŸ‰ Branch deployment completed!"
          echo ""
          echo "ğŸ“‹ Details:"
          echo "  Branch: ${{ github.ref_name }}"
          echo "  Namespace: ${{ steps.metadata.outputs.namespace }}"
          echo "  Image: ${{ env.IMAGE_TAG }}"
          echo ""
          echo "ğŸ”— Access:"
          echo "  kubectl port-forward -n ${{ steps.metadata.outputs.namespace }} svc/torale-api 8000:80"
          echo "  kubectl port-forward -n ${{ steps.metadata.outputs.namespace }} svc/torale-frontend 8080:80"
          echo ""
          kubectl get pods,svc -n ${{ steps.metadata.outputs.namespace }}
          echo ""
          echo "ğŸ—‘ï¸  Cleanup: just cleanup-branch ${{ steps.metadata.outputs.branch_slug }}"
