# Reusable workflow for building and scanning images
# Called by production and branch deployment workflows
# Uses Workload Identity Federation for keyless authentication
# Implements Docker layer caching for faster builds

name: Build and Scan

on:
  workflow_call:
    inputs:
      push_latest:
        description: 'Push :latest tag'
        required: false
        type: boolean
        default: false
    secrets:
      GCP_WORKLOAD_IDENTITY_PROVIDER:
        required: true
      GCP_SERVICE_ACCOUNT:
        required: true
      GCP_PROJECT_ID:
        required: true

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  IMAGE_TAG: ${{ github.sha }}

jobs:
  build-and-scan:
    name: Build & Scan ${{ matrix.component }}
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write  # Required for OIDC

    strategy:
      fail-fast: false
      matrix:
        include:
          - component: api
            dockerfile: backend/Dockerfile
            context: backend
            images: api,worker  # Build once, tag as both
          - component: frontend
            dockerfile: frontend/Dockerfile
            context: frontend
            images: frontend

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker gcr.io

      # Build image with GitHub Actions cache backend
      - name: Build image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          push: false  # Don't push yet - scan first
          load: true   # Load into local Docker for scanning
          tags: |
            gcr.io/${{ env.GCP_PROJECT_ID }}/torale-${{ matrix.component }}:${{ env.IMAGE_TAG }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Scan image with Trivy
      - name: Run Trivy security scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: gcr.io/${{ env.GCP_PROJECT_ID }}/torale-${{ matrix.component }}:${{ env.IMAGE_TAG }}
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'  # Don't fail on vulnerabilities (for now)
          output: 'trivy-results-${{ matrix.component }}.txt'

      - name: Upload scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-results-${{ matrix.component }}
          path: trivy-results-${{ matrix.component }}.txt
          retention-days: 30

      # Push image after successful scan
      - name: Push primary image
        run: |
          docker push gcr.io/${{ env.GCP_PROJECT_ID }}/torale-${{ matrix.component }}:${{ env.IMAGE_TAG }}

      # Handle api/worker dual tagging
      - name: Tag and push worker image
        if: matrix.component == 'api'
        run: |
          WORKER_IMAGE="gcr.io/${{ env.GCP_PROJECT_ID }}/torale-worker:${{ env.IMAGE_TAG }}"
          docker tag gcr.io/${{ env.GCP_PROJECT_ID }}/torale-${{ matrix.component }}:${{ env.IMAGE_TAG }} $WORKER_IMAGE
          docker push $WORKER_IMAGE

      # Push :latest tags if requested (production only)
      - name: Push latest tags
        if: inputs.push_latest == true
        run: |
          API_IMAGE="gcr.io/${{ env.GCP_PROJECT_ID }}/torale-${{ matrix.component }}"
          docker tag ${API_IMAGE}:${{ env.IMAGE_TAG }} ${API_IMAGE}:latest
          docker push ${API_IMAGE}:latest

          if [ "${{ matrix.component }}" = "api" ]; then
            WORKER_IMAGE="gcr.io/${{ env.GCP_PROJECT_ID }}/torale-worker"
            docker tag ${WORKER_IMAGE}:${{ env.IMAGE_TAG }} ${WORKER_IMAGE}:latest
            docker push ${WORKER_IMAGE}:latest
          fi
